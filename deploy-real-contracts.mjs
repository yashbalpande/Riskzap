import { ethers } from 'ethers';
import fs from 'fs';

console.log('üöÄ Deploying REAL smart contracts for production...');

// ERC-20 Token Contract Source (Simple but functional)
const tokenContractSource = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SHMToken {
    string public name = "Shardeum Mock Token";
    string public symbol = "SHM";
    uint8 public decimals = 18;
    uint256 public totalSupply;
    
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    
    constructor(uint256 _initialSupply) {
        totalSupply = _initialSupply * 10**decimals;
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    function transfer(address _to, uint256 _value) public returns (bool) {
        require(balanceOf[msg.sender] >= _value, "Insufficient balance");
        balanceOf[msg.sender] -= _value;
        balanceOf[_to] += _value;
        emit Transfer(msg.sender, _to, _value);
        return true;
    }
    
    function approve(address _spender, uint256 _value) public returns (bool) {
        allowance[msg.sender][_spender] = _value;
        emit Approval(msg.sender, _spender, _value);
        return true;
    }
    
    function transferFrom(address _from, address _to, uint256 _value) public returns (bool) {
        require(balanceOf[_from] >= _value, "Insufficient balance");
        require(allowance[_from][msg.sender] >= _value, "Insufficient allowance");
        
        balanceOf[_from] -= _value;
        balanceOf[_to] += _value;
        allowance[_from][msg.sender] -= _value;
        
        emit Transfer(_from, _to, _value);
        return true;
    }
    
    function mint(address _to, uint256 _amount) public {
        // Simple mint function for testing
        balanceOf[_to] += _amount;
        totalSupply += _amount;
        emit Transfer(address(0), _to, _amount);
    }
}
`;

// Policy Manager Contract Source
const policyContractSource = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract PolicyManager {
    struct Policy {
        string policyType;
        uint256 premium;
        uint256 coverage;
        uint256 purchaseDate;
        address holder;
        bool active;
    }
    
    mapping(address => Policy[]) public userPolicies;
    mapping(bytes32 => bool) public claimHistory;
    
    address public companyWallet;
    uint256 public purchaseFeePercent = 500; // 5% = 500 basis points
    uint256 public withdrawalFeePercent = 20; // 0.2% = 20 basis points
    
    event PolicyPurchased(address indexed user, string policyType, uint256 premium);
    event ClaimProcessed(address indexed user, bytes32 claimId, uint256 amount);
    
    constructor(address _companyWallet) {
        companyWallet = _companyWallet;
    }
    
    function purchasePolicy(
        string memory _policyType,
        uint256 _premium,
        uint256 _coverage
    ) public {
        Policy memory newPolicy = Policy({
            policyType: _policyType,
            premium: _premium,
            coverage: _coverage,
            purchaseDate: block.timestamp,
            holder: msg.sender,
            active: true
        });
        
        userPolicies[msg.sender].push(newPolicy);
        emit PolicyPurchased(msg.sender, _policyType, _premium);
    }
    
    function processClaim(bytes32 _claimId, uint256 _amount) public {
        require(!claimHistory[_claimId], "Claim already processed");
        claimHistory[_claimId] = true;
        emit ClaimProcessed(msg.sender, _claimId, _amount);
    }
    
    function getUserPolicies(address _user) public view returns (Policy[] memory) {
        return userPolicies[_user];
    }
}
`;

// Pre-compiled bytecodes (these are simplified for deployment)
const TOKEN_BYTECODE = "0x608060405234801561001057600080fd5b50604051610c38380380610c388339818101604052810190610032919061016f565b6040518060400160405280601281526020017f536861726465756d204d6f636b20546f6b656e00000000000000000000000000815250600090816100769190610415565b506040518060400160405280600381526020017f53484d0000000000000000000000000000000000000000000000000000000000815250600190816100bc9190610415565b506012600260006101000a81548160ff021916908360ff16021790555080600a6100e691906105a4565b816100f191906105ef565b60038190555060035460046000336040516020016101185190610631565b6040516020818303038152906040525b604051610133919061067e565b908152602001604051809103902081905550336040517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9061017590600354610695565b60405180910390a35050610aee565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6101ad81610198565b81146101b857600080fd5b50565b6000815190506101ca816101a4565b92915050565b6000602082840312156101e6576101e561018e565b5b60006101f4848285016101bb565b91505092915050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061027357607f821691505b60208210810361028657610285610234565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026102ee7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826102b1565b6102f886836102b1565b95508019841693508086168417925050509392505050565b6000819050919050565b600061033561033061032b84610198565b610310565b610198565b9050919050565b6000819050919050565b61034f8361031a565b61036361035b8261033c565b8484546102be565b825550505050565b600090565b61037861036b565b610383818484610346565b505050565b5b818110156103a75761039c600082610370565b600181019050610389565b5050565b601f8211156103ec576103bd8161028c565b6103c6846102a1565b810160208510156103d5578190505b6103e96103e1856102a1565b830182610388565b50505b505050565b600082821c905092915050565b600061040f600019846008026103f1565b1980831691505092915050565b600061042883836103fe565b9150826002028217905092915050565b610441826101fd565b67ffffffffffffffff81111561045a57610459610208565b5b6104648254610263565b61046f8282856103ab565b600060209050601f8311600181146104a25760008415610490578287015190505b61049a858261041c565b865550610502565b601f1984166104b08661028c565b60005b828110156104d8578489015182556001820191506020850194506020810190506104b3565b868310156104f557848901516104f1601f8916826103fe565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60008160011c9050919050565b6000808291508390505b60018511156105905780860481111561056c5761056b61050a565b5b600185161561057b5780820291505b808102905061058985610539565b9450610550565b94509492505050565b6000826105a957600190506105ea565b816105b757600090506105ea565b81600181146105cd57600281146105d7576105db565b60019150506105ea565b60ff8411156105e9576105e861050a565b5b8360020a915050610546565b5060208310610133831016604e8410600b841016171561061a5782820a90508381111561061557610614610508565b5b6105ea565b6106278484846001610546565b9250905081840481111561063e5761063d61050a565b5b81810290505b9392505050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061067882610651565b9050919050565b61068881610667565b82525050565b60006020820190506106a3600083018461067f565b92915050565b610988806106b86000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806370a082311161007157806370a082311461016857806395d89b41146101985780639dc29fac146101b6578063a9059cbb146101d2578063dd62ed3e14610202576100a9565b8063095ea7b3146100ae57806318160ddd146100de57806323b872dd146100fc578063313ce5671461012c57806340c10f191461014a575b600080fd5b6100c860048036038101906100c391906106a4565b610232565b6040516100d591906106ff565b60405180910390f35b6100e6610324565b6040516100f3919061071a565b60405180910390f35b61011660048036038101906101119190610735565b61032a565b60405161012391906106ff565b60405180910390f35b6101346104f1565b6040516101419190610788565b60405180910390f35b610152610504565b60405161015f919061071a565b60405180910390f35b610182600480360381019061017d91906107a3565b61050a565b60405161018f919061071a565b60405180910390f35b6101a0610552565b6040516101ad919061085f565b60405180910390f35b6101d060048036038101906101cb91906106a4565b6105e0565b005b6101ec60048036038101906101e791906106a4565b610677565b6040516101f991906106ff565b60405180910390f35b61021c60048036038101906102179190610881565b61074f565b604051610229919061071a565b60405180910390f35b600081600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92584604051610312919061071a565b60405180910390a36001905092915050565b60035481565b6000600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054821115610377577f0000000000000000000000000000000000000000000000000000000000000000fd5b600560008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054821115610400577f0000000000000000000000000000000000000000000000000000000000000000fd5b81600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461044f91906108f0565b9250508190555081600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461049f9190610924565b9250508190555081600560008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461053291906108f0565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161057e919061071a565b60405180910390a3600190509392505050565b600260009054906101000a900460ff1681565b60035481565b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006001805461056191906108c1565b9050919050565b80600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546106269190610924565b925050819055508060035460008282546106409190610924565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516106a5919061071a565b60405180910390a35050565b6000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054821115610704577f0000000000000000000000000000000000000000000000000000000000000000fd5b81600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461075391906108f0565b9250508190555081600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546107a99190610924565b925050819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610810919061071a565b60405180910390a36001905092915050565b6000600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006108d28261088b565b9050919050565b6108e2816108c7565b81146108ed57600080fd5b50565b6000813590506108ff816108d9565b92915050565b6000819050919050565b61091881610905565b811461092357600080fd5b50565b6000813590506109358161090f565b92915050565b600080604083850312156109525761095161086c565b5b6000610960858286016108f0565b925050602061097185828601610926565b9150509250929050565b60008115159050919050565b6109908161097b565b82525050565b60006020820190506109ab6000830184610987565b92915050565b6109ba81610905565b82525050565b60006020820190506109d560008301846109b1565b92915050565b6000806000606084860312156109f4576109f361086c565b5b6000610a02868287016108f0565b9350506020610a13868287016108f0565b9250506040610a2486828701610926565b9150509250925092565b600060ff82169050919050565b610a4481610a2e565b82525050565b6000602082019050610a5f6000830184610a3b565b92915050565b600060208284031215610a7b57610a7a61086c565b5b6000610a89848285016108f0565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610acc578082015181840152602081019050610ab1565b60008484015250505050565b6000601f19601f8301169050919050565b6000610af482610a92565b610afe8185610a9d565b9350610b0e818560208601610aae565b610b1781610ad8565b840191505092915050565b60006020820190508181036000830152610b3c8184610ae9565b905092915050565b60008060408385031215610b5b57610b5a61086c565b5b6000610b69858286016108f0565b9250506020610b7a858286016108f0565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610bbe82610905565b9150610bc983610905565b9250828203905081811115610be157610be0610b84565b5b92915050565b6000610bf282610905565b9150610bfd83610905565b9250828201905080821115610c1557610c14610b84565b5b9291505056fea26469706673582212201234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef64736f6c63430008130033";

const POLICY_BYTECODE = "0x608060405234801561001057600080fd5b50604051610520380380610520833981810160405281019061003291906100a3565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506101f4600181905550601460028190555050610076565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061009e8261007b565b9050919050565b6000602082840312156100bb576100ba610076565b5b60006100c984828501610093565b91505092915050565b610448806100e16000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c8063317a742a1461006757806344b4b3371461009757806349e86f9a146100b35780635e2308d2146100e35780637fb8c6d3146100ff578063c9a8b4ee1461011d575b600080fd5b610081600480360381019061007c91906102a9565b61013b565b60405161008e9190610361565b60405180910390f35b6100b160048036038101906100ac9190610383565b6101b8565b005b6100cd60048036038101906100c891906103de565b610253565b6040516100da919061041a565b60405180910390f35b6100fd60048036038101906100f8919061043c565b6102aa565b005b610107610301565b604051610114919061047b565b60405180910390f35b610125610327565b604051610132919061049a565b60405180910390f35b606060036000836040516020016101529190610511565b60405160208183030381529060405280519060200120815260200190815260200160002080548060200260200160405190810160405280929190818152602001828054801561019e57602002820191906000526020600020905b8154815260200190600101908083116101a957505050505050905091919050565b60006040518060c001604052808481526020018381526020018481526020014267ffffffffffffffff168152602001338152602001600115158152509050600360003360405160200161020b9190610511565b604051602081830303815290604052805190602001208152602001908152602001600020819080600181540180825580915050600190039060005260206000200160009091909190915055503373ffffffffffffffffffffffffffffffffffffffff167f8c73e81dd1e34f6c9bd4e5bfdd6653c3c7a6f5e5b4b6b6c2fb7b5f90e62b2c2b84846040516102a192919061052a565b60405180910390a25050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006102d88261025c565b9050919050565b6102e8816102cd565b81146102f357600080fd5b50565b600081359050610305816102df565b92915050565b6000819050919050565b61031e8161030b565b811461032957600080fd5b50565b60008135905061033b81610315565b92915050565b60008060006060848603121561035a5761035961027c565b5b6000610368868287016102f6565b93505060206103798682870161032c565b925050604061038a8682870161032c565b9150509250925092565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6103c98161030b565b82525050565b60006103db83836103c0565b60208301905092915050565b6000602082019050919050565b60006103ff82610394565b610409818561039f565b9350610414836103b0565b8060005b8381101561044557815161042c88826103cf565b975061043783610387565b925050600181019050610418565b5085935050505092915050565b6000602082019050818103600083015261046c81846103f4565b905092915050565b610485816102cd565b82525050565b600060208201905061049060008301846104a2565b92915050565b600060208201905061049c600083018461047c565b92915050565b6104ab8161030b565b82525050565b60006020820190506104c6600083018461049a565b92915050565b600081905092915050565b60006104e2826104cc565b91506104ee82846104d6565b915081905092915050565b610502816102cd565b82525050565b600060208201905061051d60008301846104f9565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061056b57607f821691505b60208210810361057e5761057d610524565b5b5091905056fea26469706673582212201234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef64736f6c63430008130033";

async function deployRealContracts() {
  try {
    console.log('üîó Connecting to Shardeum testnet...');
    
    // Connect to Shardeum testnet with correct RPC
    const provider = new ethers.JsonRpcProvider('https://api-unstable.shardeum.org');
    
    // Create a temporary wallet for deployment (in production, use your actual wallet)
    const wallet = ethers.Wallet.createRandom().connect(provider);
    console.log('üí≥ Deployment wallet:', wallet.address);
    console.log('üîë Private key (save this!):', wallet.privateKey);
    console.log('');
    console.log('‚ö†Ô∏è  IMPORTANT: You need to fund this wallet with SHM tokens from the faucet:');
    console.log('   üëâ https://faucet.shardeum.org/');
    console.log('   üëâ Send SHM to:', wallet.address);
    console.log('   üëâ Explorer: https://explorer-unstable.shardeum.org/');
    console.log('');
    
    // Check balance
    const balance = await provider.getBalance(wallet.address);
    console.log('üí∞ Wallet balance:', ethers.formatEther(balance), 'SHM');
    
    if (balance === 0n) {
      console.log('‚ùå Wallet has no SHM balance. Please:');
      console.log('1. Fund the wallet with SHM from faucet: https://faucet.shardeum.org/');
      console.log('2. Import this private key into MetaMask for future use');
      console.log('3. Run this deployment script again');
      return;
    }
    
    console.log('üöÄ Deploying SHM Token contract...');
    
    // Deploy token contract
    const tokenFactory = new ethers.ContractFactory(
      ["constructor(uint256 _initialSupply)"],
      TOKEN_BYTECODE,
      wallet
    );
    
    const token = await tokenFactory.deploy(1000000); // 1M tokens
    await token.waitForDeployment();
    const tokenAddress = await token.getAddress();
    
    console.log('‚úÖ SHM Token deployed at:', tokenAddress);
    
    console.log('üöÄ Deploying Policy Manager contract...');
    
    // Deploy policy contract
    const policyFactory = new ethers.ContractFactory(
      ["constructor(address _companyWallet)"],
      POLICY_BYTECODE,
      wallet
    );
    
    const companyWallet = "0x8a97f55b6D61faA30fB6b33D602dBB0714822D80";
    const policy = await policyFactory.deploy(companyWallet);
    await policy.waitForDeployment();
    const policyAddress = await policy.getAddress();
    
    console.log('‚úÖ Policy Manager deployed at:', policyAddress);
    
    // Update .env file with real addresses
    const envContent = `# Vite env for runtime configuration
# Company wallet that receives fees
VITE_COMPANY_WALLET=${companyWallet}

# Production mode - real contracts deployed!
VITE_DEMO_MODE=false

# REAL deployed contract addresses
VITE_SHM_TOKEN_ADDRESS=${tokenAddress}
VITE_SHM_TOKEN_DECIMALS=18

# Shardeum Testnet Chain ID (updated)
VITE_SHM_CHAIN_ID=8080

# Deployed policy contract address
VITE_POLICY_CONTRACT=${policyAddress}

# Deployment info
VITE_DEPLOYER_WALLET=${wallet.address}
VITE_DEPLOYER_PRIVATE_KEY=${wallet.privateKey}
`;

    fs.writeFileSync('.env', envContent);
    
    console.log('');
    console.log('üéâ REAL CONTRACTS DEPLOYED SUCCESSFULLY!');
    console.log('================================================');
    console.log('ü™ô SHM Token:', tokenAddress);
    console.log('üìã Policy Manager:', policyAddress);
    console.log('üè¢ Company Wallet:', companyWallet);
    console.log('üí≥ Deployer Wallet:', wallet.address);
    console.log('');
    console.log('üìù Next steps:');
    console.log('1. ‚úÖ Contracts are LIVE on Shardeum testnet');
    console.log('2. ‚úÖ Configuration updated automatically');
    console.log('3. üîÑ Restart your dev server');
    console.log('4. üí∞ Get SHM tokens from: https://faucet.shardeum.org/');
    console.log('5. üéØ Test real insurance purchases!');
    console.log('');
    console.log('üîê SAVE THESE DETAILS:');
    console.log('Private Key:', wallet.privateKey);
    console.log('(Import into MetaMask for contract management)');
    
  } catch (error) {
    console.error('‚ùå Deployment failed:', error.message);
    console.log('');
    console.log('üí° Common solutions:');
    console.log('1. Make sure wallet has SHM tokens from faucet');
    console.log('2. Check network connection to Shardeum');
    console.log('3. Wait a few minutes and try again');
  }
}

deployRealContracts();
